<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BEACON Dashboard</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link rel="manifest" href="manifest.json" />

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#007BFF",
            "background-light": "#F8F9FA",
            "background-dark": "#1A202C",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
          borderRadius: {
            DEFAULT: "0.5rem",
          },
        },
      },
    };
  </script>

  <script>
    if (localStorage.theme === "dark" || (!("theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Sidebar fixed width and active styling */
    aside {
      width: 100px !important;
    }
    a.sidebar-link.bg-primary {
      background-color: #F9FAFB !important;
      color: #007BFF !important;
      position: relative;
      box-shadow: -5px 5px 15px rgba(0, 0, 0, 0.05);
      border-top-right-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
      border-top-left-radius: 1rem !important;
      border-bottom-left-radius: 1rem !important;
      margin-right: -1px;
      z-index: 50;
    }
    .dark a.sidebar-link.bg-primary {
      background-color: #111827 !important;
      color: #60A5FA !important;
      box-shadow: none;
    }
    a.sidebar-link.bg-primary::after {
      content: "";
      position: absolute;
      right: -12px;
      top: 50%;
      transform: translateY(-50%);
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
      border-left: 12px solid #F9FAFB;
      z-index: 51;
    }
    .dark a.sidebar-link.bg-primary::after {
      border-left-color: #111827;
    }
    .sidebar-link span.ml-3 {
      display: none;
    }
    .sidebar-link {
      justify-content: center;
      flex-direction: column;
      height: 80px;
      width: 80px;
      margin: 0 auto 1rem auto;
      border-radius: 1rem;
      transition: all 0.3s ease;
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 font-display text-gray-800 dark:text-gray-200 overflow-hidden">
  <div class="flex h-screen w-full">
    <!-- Sidebar -->
    <aside class="bg-slate-900 text-white flex flex-col shadow-2xl z-40 shrink-0 items-center py-6">
    
    <div class="mb-8">
      <a href="index.html" class="block w-14 h-14 rounded-xl shadow-lg overflow-hidden hover:scale-105 transition-transform bg-transparent">
        <img src="images/beacon.png" alt="BEACON Logo" class="w-full h-full object-cover block" />
      </a>
    </div>

    <nav class="flex-1 w-full px-2 space-y-4 overflow-y-auto no-scrollbar">
      <a href="index.html" class="sidebar-link bg-primary flex items-center text-gray-400 hover:bg-white/10 hover:text-white relative group">
        <span class="material-icons text-3xl">dashboard</span>
        <div class="absolute left-full ml-4 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50">
          Dashboard
        </div>
      </a>

      <a href="reports.html" class="sidebar-link flex items-center text-gray-400 hover:bg-white/10 hover:text-white relative group">
        <span class="material-icons text-3xl">assessment</span>
        <div class="absolute left-full ml-4 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50">
          Reports
        </div>
      </a>

      <a href="outages.html" class="sidebar-link flex items-center text-gray-400 hover:bg-white/10 hover:text-white relative group">
        <span class="material-icons text-3xl">warning</span>
        <div class="absolute left-full ml-4 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50">
          Outages
        </div>
      </a>

      <a href="map.html" class="sidebar-link flex items-center text-gray-400 hover:bg-white/10 hover:text-white relative group">
        <span class="material-icons text-3xl">map</span>
        <div class="absolute left-full ml-4 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50">
          Map View
        </div>
      </a>

      <a href="notifications.html" class="sidebar-link flex items-center text-gray-400 hover:bg-white/10 hover:text-white relative group">
        <span class="material-icons text-3xl">notifications</span>
        <div class="absolute left-full ml-4 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50">
          Notifications
        </div>
      </a>

      <a href="settings.html" class="sidebar-link flex items-center text-gray-400 hover:bg-white/10 hover:text-white relative group">
        <span class="material-icons text-3xl">settings</span>
        <div class="absolute left-full ml-4 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50">
          Settings
        </div>
      </a>
    </nav>

    <div class="mt-auto mb-4 flex flex-col gap-4 items-center w-full border-t border-white/10 pt-6">
      <div id="profileDropdownWrapper" class="relative">
        <button id="profileTrigger" class="w-12 h-12 rounded-full overflow-hidden border-2 border-gray-500 hover:border-white transition">
          <img id="adminProfile" src="https://via.placeholder.com/40" alt="Admin" class="w-full h-full object-cover" />
        </button>
        <div id="profileDropdown" class="hidden absolute left-14 bottom-0 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl z-50 p-2">
          <a href="#" id="openProfileModalBtn" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-700 rounded">
            Profile
          </a>
          <a href="login.html" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 rounded">
            Logout
          </a>
        </div>
      </div>
    </div>
  </aside>

    <!-- Main content -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative bg-gray-50 dark:bg-gray-900 z-0">
      <header class="h-16 bg-transparent flex justify-between items-center px-8 py-4 shrink-0">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white tracking-tight">
          BEACON <span class="text-blue-600">Dashboard</span>
        </h2>
        <!-- Old Date Picker Removed -->
      </header>

      <main class="flex-1 overflow-y-auto px-8 pb-8 scroll-smooth">
        <!-- KPI Tiles -->
        <div id="dashboardTiles" class="grid grid-cols-1 sm:grid-cols-3 gap-6 mt-2">
          <!-- Total Reports -->
          <div class="group relative overflow-hidden rounded-[2rem] border border-white/50 dark:border-gray-700 bg-gradient-to-br from-white to-red-50 dark:from-gray-800 dark:to-red-900/10 p-6 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all duration-300">
            <div class="absolute -right-6 -bottom-6 opacity-5 group-hover:opacity-10 group-hover:scale-110 transition-all duration-500">
              <span class="material-icons text-[10rem] text-red-600">assignment_late</span>
            </div>
            <div class="relative z-10 flex justify-between items-start">
              <div>
                <div class="w-12 h-12 rounded-2xl bg-red-100 dark:bg-red-900/30 flex items-center justify-center mb-4 text-red-600 dark:text-red-400">
                  <span class="material-icons text-2xl">assignment_late</span>
                </div>
                <h3 class="text-gray-500 dark:text-gray-400 font-medium text-sm uppercase tracking-wide">
                  Total Reports
                </h3>
                <p id="value-total" class="text-5xl font-black text-gray-800 dark:text-white mt-2 tracking-tight">0</p>
              </div>
            </div>
            <div class="relative z-10 flex items-center mt-4 gap-2">
              <div id="trend-total"
                   class="flex items-center gap-1 px-2.5 py-1 rounded-full bg-white/60 dark:bg-gray-700/50 border border-red-100 dark:border-red-900/30 backdrop-blur-sm">
                <span id="icon-total" class="material-icons text-sm text-green-500">arrow_upward</span>
                <span id="trendPercent-total" class="text-xs font-bold text-green-600 dark:text-green-400">0</span>
              </div>
              <span class="text-xs text-gray-400 font-medium">vs previous period</span>
            </div>
          </div>

          <!-- Active Outages -->
          <div class="group relative overflow-hidden rounded-[2rem] border border-white/50 dark:border-gray-700 bg-gradient-to-br from-white to-orange-50 dark:from-gray-800 dark:to-orange-900/10 p-6 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all duration-300">
            <div class="absolute -right-6 -bottom-6 opacity-5 group-hover:opacity-10 group-hover:scale-110 transition-all duration-500">
              <span class="material-icons text-[10rem] text-orange-500">bolt</span>
            </div>
            <div class="relative z-10 flex justify-between items-start">
              <div>
                <div class="w-12 h-12 rounded-2xl bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center mb-4 text-orange-600 dark:text-orange-400">
                  <span class="material-icons text-2xl">bolt</span>
                </div>
                <h3 class="text-gray-500 dark:text-gray-400 font-medium text-sm uppercase tracking-wide">
                  Active Outages
                </h3>
                <p id="value-active" class="text-5xl font-black text-gray-800 dark:text-white mt-2 tracking-tight">0</p>
              </div>
            </div>
            <div class="relative z-10 flex items-center mt-4 gap-2">
              <div id="trend-active"
                   class="flex items-center gap-1 px-2.5 py-1 rounded-full bg-white/60 dark:bg-gray-700/50 border border-orange-100 dark:border-orange-900/30 backdrop-blur-sm">
                <span id="icon-active" class="material-icons text-sm text-green-500">arrow_upward</span>
                <span id="trendPercent-active" class="text-xs font-bold text-green-600 dark:text-green-400">0</span>
              </div>
              <span class="text-xs text-gray-400 font-medium">vs previous period</span>
            </div>
          </div>

          <!-- Restored -->
          <div class="group relative overflow-hidden rounded-[2rem] border border-white/50 dark:border-gray-700 bg-gradient-to-br from-white to-emerald-50 dark:from-gray-800 dark:to-emerald-900/10 p-6 shadow-sm hover:shadow-md hover:-translate-y-1 transition-all duration-300">
            <div class="absolute -right-6 -bottom-6 opacity-5 group-hover:opacity-10 group-hover:scale-110 transition-all duration-500">
              <span class="material-icons text-[10rem] text-emerald-500">check_circle</span>
            </div>
            <div class="relative z-10 flex justify-between items-start">
              <div>
                <div class="w-12 h-12 rounded-2xl bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center mb-4 text-emerald-600 dark:text-emerald-400">
                  <span class="material-icons text-2xl">check_circle</span>
                </div>
                <h3 class="text-gray-500 dark:text-gray-400 font-medium text-sm uppercase tracking-wide">
                  Restored
                </h3>
                <p id="value-completed" class="text-5xl font-black text-gray-800 dark:text-white mt-2 tracking-tight">0</p>
              </div>
            </div>
            <div class="relative z-10 flex items-center mt-4 gap-2">
              <div id="trend-completed"
                   class="flex items-center gap-1 px-2.5 py-1 rounded-full bg-white/60 dark:bg-gray-700/50 border border-emerald-100 dark:border-emerald-900/30 backdrop-blur-sm">
                <span id="icon-completed" class="material-icons text-sm text-green-500">arrow_upward</span>
                <span id="trendPercent-completed" class="text-xs font-bold text-green-600 dark:text-green-400">0</span>
              </div>
              <span class="text-xs text-gray-400 font-medium">vs previous period</span>
            </div>
          </div>
        </div>

        <!-- Recent Reports -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mt-8 mb-6">
          <div class="flex justify-between items-center mb-4">
            <h4 class="font-bold text-lg text-gray-700 dark:text-gray-300">Recent Outage Reports</h4>
            <a href="reports.html" class="text-sm text-blue-500 hover:text-blue-600 font-medium">View All</a>
          </div>
          <div class="overflow-x-auto">
            <table id="reportsTable" class="w-full text-left">
              <thead>
                <tr class="text-xs text-gray-500 dark:text-gray-400 border-b dark:border-gray-700 uppercase tracking-wider">
                  <th class="py-3 px-4 font-medium">Report ID</th>
                  <th class="py-3 px-4 font-medium">Common Cause</th>
                  <th class="py-3 px-4 font-medium">Feeder</th>
                  <th class="py-3 px-4 font-medium">Reported</th>
                  <th class="py-3 px-4 font-medium">Status</th>
                  <th class="py-3 px-4 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody id="reportsBody" class="text-sm text-gray-600 dark:text-gray-300">
                <tr>
                  <td colspan="6" class="py-6 text-center text-gray-400 dark:text-gray-500">
                    No outage reports available.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="flex justify-center items-center mt-6 space-x-4">
            <button id="prevPage"
                    class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 text-sm px-4 py-2 rounded-lg disabled:opacity-50 hover:bg-gray-200 transition">
              Previous
            </button>
            <span id="pageIndicator"
                  class="text-gray-700 dark:text-gray-300 text-xs font-semibold uppercase tracking-wide">
              Page 1 of 1
            </span>
            <button id="nextPage"
                    class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 text-sm px-4 py-2 rounded-lg disabled:opacity-50 hover:bg-gray-200 transition">
              Next
            </button>
          </div>
        </div>

        <!-- Analytics & Forecasting -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 mt-8 gap-4">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white">Analytics Overview</h3>
          
          <div class="flex items-center gap-2">
            <!-- New Date Range Picker -->
            <div class="relative z-[100]">
                <button id="dateRangeBtn" class="bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-200 border border-gray-200 dark:border-gray-700 px-4 py-2 rounded-lg flex items-center gap-2 text-sm shadow-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                  <span class="material-icons text-base text-gray-400">date_range</span>
                  <span id="dateRangeLabel">Select Date Range</span>
                  <span class="material-icons text-base text-gray-400">expand_more</span>
                </button>
    
                <div id="dateRangeDropdown" class="hidden absolute right-0 mt-2 w-72 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 p-4 z-50">
                  <div class="space-y-3">
                    <div>
                      <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Start Date</label>
                      <input type="date" id="rangeStart" class="w-full p-2 text-sm border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                       <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">End Date</label>
                       <input type="date" id="rangeEnd" class="w-full p-2 text-sm border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <button id="applyDateRangeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-medium transition shadow-md shadow-blue-500/20">
                      Apply Range
                    </button>
                  </div>
                </div>
            </div>

            <button id="downloadReportBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition shadow-sm shadow-blue-500/30">
              <span class="material-icons text-sm">picture_as_pdf</span>
              <span class="text-sm font-medium">Download Report</span>
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
          <!-- Outages per Feeder -->
          <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col">
            <div class="flex justify-between items-center mb-4">
              <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wide">
                Outages per Feeder
              </h4>
              <div class="relative">
                <button id="feederFilterBtn"
                        class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-md text-xs font-medium flex items-center gap-2 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                  <span class="material-icons text-xs">filter_list</span>
                  Filter
                </button>
                <div id="feederFilterPopup"
                     class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50 hidden">
                  <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h5 class="font-semibold text-gray-800 dark:text-gray-200">Filter by Feeder</h5>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                      Select feeders to display
                    </p>
                  </div>
                  <div class="flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700">
                    <button id="feederSelectAll"
                            class="text-blue-600 dark:text-blue-400 text-sm font-medium hover:text-blue-700 dark:hover:text-blue-300 transition-colors">
                      Select All
                    </button>
                    <button id="feederClear"
                            class="text-red-600 dark:text-red-400 text-sm font-medium hover:text-red-700 dark:hover:text-red-300 transition-colors">
                      Clear All
                    </button>
                  </div>
                  <div class="max-h-60 overflow-y-auto p-2">
                    <div id="feederList" class="space-y-1"></div>
                  </div>
                  <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 rounded-b-lg">
                    <button id="feederApply"
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded text-sm font-medium transition-colors">
                      Apply Filters
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="chart-wrapper h-72 w-full relative">
              <canvas id="feederChartCanvas" class="w-full h-full"></canvas>
            </div>
            <p id="feederChartLabel" class="mt-auto text-xs text-gray-400 text-center">
              All feeders selected
            </p>
          </div>

          <!-- Restoration Time -->
          <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col">
            <div class="flex justify-between items-center mb-4">
              <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wide">
                Avg. Restoration Time (Hours)
              </h4>
              <div class="relative">
                <button id="restorationFilterBtn"
                        class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-md text-xs font-medium flex items-center gap-2 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                  <span class="material-icons text-xs">filter_list</span>
                  Filter
                </button>
                <div id="restorationFilterPopup"
                     class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50 hidden">
                  <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <h5 class="font-semibold text-gray-800 dark:text-gray-200">Filter by Feeder</h5>
                  </div>
                  <div class="flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700">
                    <button id="restorationSelectAll" class="text-blue-600 text-sm font-medium">
                      Select All
                    </button>
                    <button id="restorationClear" class="text-red-600 text-sm font-medium">
                      Clear All
                    </button>
                  </div>
                  <div class="max-h-60 overflow-y-auto p-2">
                    <div id="restorationFeederList" class="space-y-1"></div>
                  </div>
                  <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900 rounded-b-lg">
                    <button id="restorationApply"
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded text-sm font-medium">
                      Apply Filters
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="chart-wrapper h-72 w-full relative">
              <canvas id="restorationChartCanvas" class="w-full h-full"></canvas>
            </div>
            <p id="restorationChartLabel" class="mt-auto text-xs text-gray-400 text-center">
              All feeders selected
            </p>
          </div>

          <!-- Advanced Metrics -->
          <h3 class="lg:col-span-5 text-xl font-bold mt-4 text-gray-800 dark:text-white">
            Advanced Metrics
          </h3>

          <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col">
            <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wide mb-4">
              Root Cause Analysis
            </h4>
            <div class="h-64 w-full relative">
              <canvas id="rootCauseChart" class="w-full h-full"></canvas>
            </div>
            <p class="text-xs text-gray-400 mt-2 text-center">
              Top reasons for outages
            </p>
          </div>

          <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col">
            <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wide mb-4">
              Most Affected Barangays
            </h4>
            <div class="h-64 w-full relative">
              <canvas id="barangayImpactChart" class="w-full h-full"></canvas>
            </div>
            <p class="text-xs text-gray-400 mt-2 text-center">
              Frequency of outages per area
            </p>
          </div>

          <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col">
            <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wide mb-4">
              Peak Outage Times
            </h4>
            <div class="h-64 w-full relative">
              <canvas id="peakTimeChart" class="w-full h-full"></canvas>
            </div>
            <p class="text-xs text-gray-400 mt-2 text-center">
              Bubble size indicates outage frequency
            </p>
          </div>

          <!-- REPLACEMENT: Root Cause Sentiment Analysis Card -->
          <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col">
            <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wide mb-4">
              Root Cause Sentiment Analysis
            </h4>
            <div class="h-64 w-full relative">
              <div id="root-cause-chart-container" class="w-full h-full overflow-y-auto pr-2">
                <div class="flex items-center justify-center h-full text-gray-400 text-xs">
                  Initializing analysis...
                </div>
              </div>
            </div>
            <p class="text-xs text-gray-400 mt-2 text-center">
              <span style="color:#e74c3c">● Negative</span> 
              <span style="color:#f1c40f">● Neutral</span> 
              <span style="color:#2ecc71">● Positive</span>
            </p>
          </div>

          <!-- NEW: Forecasting & Risk Outlook -->
          <div class="lg:col-span-5 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col mt-2">
            <div class="flex justify-between items-center mb-4">
              <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wide">
                Forecasting & Risk Outlook (Next 7 Days)
              </h4>
              <span id="forecastHorizon"
                    class="text-xs text-gray-400 dark:text-gray-500">
                Horizon: 7 days, based on historical frequency
              </span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <!-- Feeder Risk Forecast -->
              <div class="bg-gray-50 dark:bg-gray-900/60 rounded-xl border border-gray-100 dark:border-gray-700 p-4 flex flex-col">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <span class="material-icons text-blue-500 text-xl">electrical_services</span>
                    <h5 class="font-semibold text-gray-700 dark:text-gray-200 text-sm uppercase tracking-wide">
                      Feeder Risk Forecast
                    </h5>
                  </div>
                  <span id="forecastFeederUpdated"
                        class="text-[10px] text-gray-400 uppercase tracking-wide">
                        —
                  </span>
                </div>
                <div class="h-48 relative">
                  <canvas id="feederForecastChart" class="w-full h-full"></canvas>
                </div>
                <p id="feederForecastSummary" class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                  Loading feeder risk forecast...
                </p>
              </div>

              <!-- Barangay Risk Forecast -->
              <div class="bg-gray-50 dark:bg-gray-900/60 rounded-xl border border-gray-100 dark:border-gray-700 p-4 flex flex-col">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <span class="material-icons text-rose-500 text-xl">location_city</span>
                    <h5 class="font-semibold text-gray-700 dark:text-gray-200 text-sm uppercase tracking-wide">
                      Barangay Risk Forecast
                    </h5>
                  </div>
                  <span id="forecastBarangayUpdated"
                        class="text-[10px] text-gray-400 uppercase tracking-wide">
                        —
                  </span>
                </div>
                <div class="h-48 relative">
                  <canvas id="barangayForecastChart" class="w-full h-full"></canvas>
                </div>
                <p id="barangayForecastSummary" class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                  Loading barangay risk forecast...
                </p>
              </div>

              <!-- Restoration Likelihood & Text Insights -->
              <div class="bg-gray-50 dark:bg-gray-900/60 rounded-xl border border-gray-100 dark:border-gray-700 p-4 flex flex-col">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-2">
                    <span class="material-icons text-emerald-500 text-xl">auto_fix_high</span>
                    <h5 class="font-semibold text-gray-700 dark:text-gray-200 text-sm uppercase tracking-wide">
                      Restoration Likelihood
                    </h5>
                  </div>
                  <span id="forecastRestorationUpdated"
                        class="text-[10px] text-gray-400 uppercase tracking-wide">
                        —
                  </span>
                </div>
                <div class="h-32 relative mb-3">
                  <canvas id="restorationForecastChart" class="w-full h-full"></canvas>
                </div>
                <div class="mt-1 space-y-1 text-[11px] text-gray-500 dark:text-gray-400">
                  <p id="restorationForecastSummary">
                    Estimating probability of completion within 4 / 8 / 24 hours per feeder group.
                  </p>
                  <p id="overallRiskBadge"
                     class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300 font-semibold mt-1">
                    <span class="material-icons text-xs">insights</span>
                    Overall risk: —
                  </p>
                </div>
              </div>
            </div>

            <!-- Optional text table for top risky assets -->
            <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4 text-xs">
              <div>
                <h6 class="font-semibold text-gray-700 dark:text-gray-200 mb-1 flex items-center gap-1">
                  <span class="material-icons text-[14px] text-blue-500">trending_up</span>
                  Top Feeder Risk (Next 7 Days)
                </h6>
                <ul id="feederRiskList" class="space-y-1 text-gray-600 dark:text-gray-300">
                  <li class="text-gray-400">Waiting for data...</li>
                </ul>
              </div>
              <div>
                <h6 class="font-semibold text-gray-700 dark:text-gray-200 mb-1 flex items-center gap-1">
                  <span class="material-icons text-[14px] text-rose-500">place</span>
                  Top Barangay Risk (Next 7 Days)
                </h6>
                <ul id="barangayRiskList" class="space-y-1 text-gray-600 dark:text-gray-300">
                  <li class="text-gray-400">Waiting for data...</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Heatmap -->
        <div class="lg:col-span-5 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col mb-8 relative">
          <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wide mb-4">
            Outage Density Heatmap
          </h4>
          <div class="absolute top-6 right-6 z-[400]">
            <button id="heatmapFilterBtn"
                    class="px-3 py-1.5 bg-white dark:bg-gray-700 rounded-lg text-xs font-medium shadow-md flex items-center gap-2 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors relative">
              <span class="material-icons text-xs">filter_list</span>
              <span>Filter Map</span>
              <span class="material-icons text-[16px]">expand_more</span>
              <span class="hidden ml-2 text-[10px] text-gray-500 dark:text-gray-400"></span>
            </button>
            <div id="heatmapFilterPopup"
                 class="hidden absolute right-0 mt-2 w-44 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-3 space-y-2 z-[401]">
              <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                <input type="radio" name="heatmapFilter" value="pending" checked />
                <span class="text-gray-700 dark:text-gray-300 text-sm">Pending only</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                <input type="radio" name="heatmapFilter" value="reportedongoing" />
                <span class="text-gray-700 dark:text-gray-300 text-sm">Reported & Ongoing</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                <input type="radio" name="heatmapFilter" value="all" />
                <span class="text-gray-700 dark:text-gray-300 text-sm">All</span>
              </label>
              <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
              <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-gray-50 dark:hover:bg-gray-700 rounded">
                <input type="checkbox" id="heatmapUseDateRange" />
                <span class="text-gray-700 dark:text-gray-300 text-xs">Use selected date range</span>
              </label>
            </div>
          </div>
          <div id="map"
               class="w-full h-[700px] rounded-xl overflow-hidden shadow-inner bg-gray-100 dark:bg-gray-900 z-0"></div>
          <p class="text-xs text-gray-400 mt-2 text-center">
            Map data © <a href="https://www.openstreetmap.org/copyright"
                         target="_blank"
                         class="underline">OpenStreetMap contributors</a>
          </p>
        </div>

        <!-- Barangay breakdown (hidden section you already had) -->
        <div id="barangayBreakdown"
             class="hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mt-6">
          <h4 class="font-bold text-gray-700 dark:text-gray-300 text-sm uppercase tracking-wide mb-4">
            Barangay Report Breakdown
          </h4>
          <div class="overflow-x-auto">
            <table id="barangayTable" class="w-full text-left">
              <thead>
                <tr class="text-xs text-gray-500 dark:text-gray-400 border-b dark:border-gray-700 uppercase tracking-wide">
                  <th class="py-3 px-4 font-medium">Barangay</th>
                  <th class="py-3 px-4 font-medium">Total Reports</th>
                </tr>
              </thead>
              <tbody id="barangayBody" class="text-sm text-gray-600 dark:text-gray-300"></tbody>
            </table>
          </div>
          <button id="backToDashboard"
                  class="mt-6 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition text-sm font-medium">
            Back to Dashboard
          </button>
        </div>
      </main>
    </div>
  </div>

  <!-- Templates, Profile modal, PDF preview modal (unchanged from your file) -->
  <template id="calendarIconTemplate">
    <span class="material-icons">calendar_today</span>
  </template>
  <template id="arrowDownTemplate">
    <span class="material-icons">expand_more</span>
  </template>

  <div id="profileModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden items-center justify-center z-[1001]">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 relative">
      
      <div class="flex justify-between items-center pb-4 border-b dark:border-gray-700">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Profile Settings</h3>
        <button id="closeProfileModalBtn" class="text-gray-400 hover:text-gray-600 transition">
          <span class="material-icons">close</span>
        </button>
      </div>

      <form id="profileUpdateForm" class="mt-6 space-y-5 max-h-[80vh] overflow-y-auto pr-2 custom-scrollbar">
        
        <div class="flex flex-col items-center justify-center mb-6">
            <div class="relative group">
                <div class="w-28 h-28 rounded-full overflow-hidden border-4 border-gray-100 dark:border-gray-700 shadow-lg">
                    <img id="modalProfilePreview" src="https://via.placeholder.com/150" alt="Profile" class="w-full h-full object-cover">
                </div>
                <label for="profilePictureInput" class="absolute bottom-1 right-1 bg-blue-600 text-white p-2 rounded-full cursor-pointer hover:bg-blue-700 shadow-md transition-transform transform hover:scale-105">
                    <span class="material-icons text-sm">edit</span>
                </label>
                <input type="file" id="profilePictureInput" accept="image/*" class="hidden"/>
            </div>
            <p class="text-xs text-gray-500 mt-2">Click icon to change photo</p>
        </div>

        <div>
           <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Email Address</label>
           <input type="email" id="profileEmailInput" disabled class="w-full px-4 py-3 rounded-xl bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed select-none">
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">First Name</label>
                <input type="text" id="firstNameInput" class="w-full px-4 py-3 rounded-xl border-gray-300 focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition" placeholder="Juan">
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Last Name</label>
                <input type="text" id="lastNameInput" class="w-full px-4 py-3 rounded-xl border-gray-300 focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition" placeholder="Dela Cruz">
            </div>
        </div>

        <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Mobile Number</label>
            <input type="text" id="mobileInput" class="w-full px-4 py-3 rounded-xl border-gray-300 focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition" placeholder="0912 345 6789">
        </div>

        <div class="pt-4 border-t dark:border-gray-700">
            <h4 class="text-sm font-bold text-gray-800 dark:text-white mb-3">Change Password</h4>
            <div class="space-y-3">
                <input type="password" id="newPasswordInput" class="w-full px-4 py-3 rounded-xl border-gray-300 focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition" placeholder="New Password (Optional)">
                <input type="password" id="confirmPasswordInput" class="w-full px-4 py-3 rounded-xl border-gray-300 focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white transition" placeholder="Confirm New Password">
            </div>
        </div>

        <div class="pt-4 flex justify-end space-x-3">
            <button type="button" id="cancelUpdateBtn" class="px-5 py-2.5 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 transition">Cancel</button>
            <button type="submit" id="saveProfileBtn" class="px-5 py-2.5 rounded-xl text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <div id="pdfPreviewModal"
       class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm hidden items-center justify-center z-[1002]">
    <div class="bg-white dark:bg-gray-800 w-full max-w-5xl h-[90vh] flex flex-col rounded-xl shadow-2xl overflow-hidden transform transition-all">
      <div class="flex justify-between items-center px-6 py-4 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
        <div>
          <h3 class="text-lg font-bold text-gray-800 dark:text-white">Report Preview</h3>
          <p class="text-xs text-gray-500 dark:text-gray-400">
            Review analysis before downloading
          </p>
        </div>
        <button id="closePreviewBtn"
                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="flex-1 bg-gray-200 dark:bg-gray-900 p-4 overflow-hidden flex justify-center items-center relative">
        <div id="pdfLoading"
             class="hidden absolute flex flex-col items-center z-10">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-3"></div>
          <span class="text-gray-600 dark:text-gray-300 font-medium">
            Generating Report...
          </span>
        </div>
        <iframe id="pdfPreviewFrame"
                class="w-full h-full rounded shadow-lg border border-gray-300 dark:border-gray-700 bg-white z-0"></iframe>
      </div>
      <div class="px-6 py-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex justify-end space-x-3">
        <button id="cancelPreviewBtn"
                class="px-5 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition">
          Close
        </button>
        <button id="confirmDownloadBtn"
                class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg flex items-center gap-2 shadow-md transition hover:-translate-y-0.5">
          <span class="material-icons text-sm">download</span>
          <span>Download Final Report</span>
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="scripts/supabase.js"></script>
  <script src="scripts/shared.js"></script>
  <script src="scripts/dashboard.js" defer></script>
</body>
</html>